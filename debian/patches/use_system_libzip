Description: Use the system libzip instead of something in third-party.
 There is a version of libzip in third-party that shouldn't be used.
 .
 Mimicking PHP, HHVM has imported as well libzip into its tree in order
 to use the internals of libzip.  In 0.11 libzip exposed the _zip_free()
 symbol as zip_discard(), so use that and conditionally supply that
 primitive if our version is not enough with copies from the libzip tree
 for only a handful of files.
Author: David Mart√≠nez Moreno <ender@debian.org>
Forwarded: no
Last-Update: 2014-05-26

--- /dev/null
+++ b/CMake/FindLibZip.cmake
@@ -0,0 +1,30 @@
+# Finds libzip.
+#
+# This module defines:
+# LIBZIP_INCLUDE_DIR_ZIP
+# LIBZIP_INCLUDE_DIR_ZIPCONF
+# LIBZIP_LIBRARY
+#
+
+find_package(PkgConfig)
+pkg_check_modules(PC_LIBZIP QUIET libzip)
+
+find_path(LIBZIP_INCLUDE_DIR_ZIP
+    NAMES zip.h
+    HINTS ${PC_LIBZIP_INCLUDE_DIRS})
+
+find_path(LIBZIP_INCLUDE_DIR_ZIPCONF
+    NAMES zipconf.h
+    HINTS ${PC_LIBZIP_INCLUDE_DIRS})
+
+find_library(LIBZIP_LIBRARY
+    NAMES zip)
+
+include(FindPackageHandleStandardArgs)
+FIND_PACKAGE_HANDLE_STANDARD_ARGS(
+    LIBZIP DEFAULT_MSG
+    LIBZIP_LIBRARY LIBZIP_INCLUDE_DIR_ZIP LIBZIP_INCLUDE_DIR_ZIPCONF)
+
+if (NOT LIBZIP_FOUND)
+    message(FATAL_ERROR "Could not locate LIBZIP.")
+endif (NOT LIBZIP_FOUND)
--- a/CMake/HPHPFindLibs.cmake
+++ b/CMake/HPHPFindLibs.cmake
@@ -135,6 +135,10 @@ add_definitions(${LIBXSLT_DEFINITIONS})
 find_package(EXPAT REQUIRED)
 include_directories(${EXPAT_INCLUDE_DIRS})
 
+# libzip
+find_package(LibZip REQUIRED)
+include_directories(${LIBZIP_INCLUDE_DIR_ZIP} ${LIBZIP_INCLUDE_DIR_ZIPCONF})
+
 # ICU
 find_package(ICU REQUIRED)
 if (ICU_FOUND)
@@ -444,7 +448,7 @@ macro(hphp_link target)
   target_link_libraries(${target} lz4)
   target_link_libraries(${target} double-conversion)
   target_link_libraries(${target} folly)
-  target_link_libraries(${target} zip_static)
+  target_link_libraries(${target} zip)
 
   target_link_libraries(${target} afdt)
   target_link_libraries(${target} mbfl)
--- a/CMake/HPHPSetup.cmake
+++ b/CMake/HPHPSetup.cmake
@@ -164,7 +164,6 @@ include_directories("${TP_DIR}/libmbfl/f
 include_directories("${TP_DIR}/lz4")
 include_directories("${TP_DIR}/double-conversion/src")
 include_directories("${TP_DIR}/folly")
-include_directories("${TP_DIR}/libzip")
 include_directories(${TP_DIR})
 
 include_directories(${HPHP_HOME}/hphp)
--- a/third-party/CMakeLists.txt
+++ b/third-party/CMakeLists.txt
@@ -30,8 +30,7 @@ list(APPEND THIRD_PARTY_MODULES
   timelib
   lz4
   double-conversion
-  folly
-  libzip)
+  folly)
 if(ENABLE_FASTCGI)
   list(APPEND THIRD_PARTY_MODULES ti)
   list(APPEND THIRD_PARTY_MODULES thrift)
