Description: Use the system libzip instead of something in third-party.
 There is a version of libzip in third-party that shouldn't be used.
 .
 Mimicking PHP, HHVM has imported as well libzip into its tree in order
 to use the internals of libzip.  In 0.11 libzip exposed the _zip_free()
 symbol as zip_discard(), so use that and conditionally supply that
 primitive if our version is not enough with copies from the libzip tree
 for only a handful of files.
 .
 TODO: For now just remove the entire libzip directory, as I haven't
 finished the pull request for the Github tree.
Author: David Mart√≠nez Moreno <ender@debian.org>
Forwarded: no
Last-Update: 2014-03-04

--- /dev/null
+++ b/CMake/FindLibZip.cmake
@@ -0,0 +1,30 @@
+# Finds libzip.
+#
+# This module defines:
+# LIBZIP_INCLUDE_DIR_ZIP
+# LIBZIP_INCLUDE_DIR_ZIPCONF
+# LIBZIP_LIBRARY
+#
+
+find_package(PkgConfig)
+pkg_check_modules(PC_LIBZIP QUIET libzip)
+
+find_path(LIBZIP_INCLUDE_DIR_ZIP
+    NAMES zip.h
+    HINTS ${PC_LIBZIP_INCLUDE_DIRS})
+
+find_path(LIBZIP_INCLUDE_DIR_ZIPCONF
+    NAMES zipconf.h
+    HINTS ${PC_LIBZIP_INCLUDE_DIRS})
+
+find_library(LIBZIP_LIBRARY
+    NAMES zip)
+
+include(FindPackageHandleStandardArgs)
+FIND_PACKAGE_HANDLE_STANDARD_ARGS(
+    LIBZIP DEFAULT_MSG
+    LIBZIP_LIBRARY LIBZIP_INCLUDE_DIR_ZIP LIBZIP_INCLUDE_DIR_ZIPCONF)
+
+if (NOT LIBZIP_FOUND)
+    message(FATAL_ERROR "Could not locate LIBZIP.")
+endif (NOT LIBZIP_FOUND)
--- a/CMake/HPHPFindLibs.cmake
+++ b/CMake/HPHPFindLibs.cmake
@@ -167,7 +167,10 @@ include_directories("${HPHP_HOME}/hphp/t
 include_directories("${HPHP_HOME}/hphp/third_party/lz4")
 include_directories("${HPHP_HOME}/hphp/third_party/double-conversion/src")
 include_directories("${HPHP_HOME}/hphp/third_party/folly")
-include_directories("${HPHP_HOME}/hphp/third_party/libzip")
+
+# libzip
+find_package(LibZip REQUIRED)
+include_directories(${LIBZIP_INCLUDE_DIR_ZIP} ${LIBZIP_INCLUDE_DIR_ZIPCONF})
 
 # ICU
 find_package(ICU REQUIRED)
@@ -521,7 +524,7 @@ endif()
 	target_link_libraries(${target} lz4)
 	target_link_libraries(${target} double-conversion)
 	target_link_libraries(${target} folly)
-	target_link_libraries(${target} zip_static)
+	target_link_libraries(${target} zip)
 
 	target_link_libraries(${target} afdt)
 	target_link_libraries(${target} mbfl)
--- a/hphp/CMakeLists.txt
+++ b/hphp/CMakeLists.txt
@@ -30,7 +30,6 @@ add_subdirectory(third_party/timelib)
 add_subdirectory(third_party/lz4)
 add_subdirectory(third_party/double-conversion)
 add_subdirectory(third_party/folly)
-add_subdirectory(third_party/libzip)
 if(ENABLE_FASTCGI)
 	add_subdirectory(third_party/ti)
 	add_subdirectory(third_party/thrift)
